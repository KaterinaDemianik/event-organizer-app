{% extends "base.html" %}
{% block title %}{{ event.title }} · Event Organizer{% endblock %}
{% block content %}
  <article class="card event-detail">
    
    <header class="event-detail-header">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 24px;">
        <h1 style="margin: 0; font-size: 1.4rem; font-weight: 700; line-height: 1.3; color: var(--text);">{{ event.title }}</h1>
        <span class="badge {{ event.status }}" style="font-size: 13px; padding: 6px 14px; white-space: nowrap;">{{ event.get_status_display }}</span>
      </div>
    </header>
    
    
    <div class="event-info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 28px; padding: 20px; background: var(--bg); border-radius: 12px;">
      <div class="info-item">
        <div style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Дата та час</div>
        <div style="font-size: 15px; font-weight: 500; color: var(--text);">{{ event.starts_at|date:"d.m.Y H:i" }}</div>
        <div style="font-size: 14px; color: var(--muted); margin-top: 2px;">до {{ event.ends_at|date:"d.m.Y H:i" }}</div>
      </div>
      
      <div class="info-item">
        <div style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Локація</div>
        <div style="font-size: 15px; font-weight: 500; color: var(--text);">{{ event.location }}</div>
      </div>
      
      <div class="info-item">
        <div style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Організатор</div>
        <div style="font-size: 15px; font-weight: 500; color: var(--text);">{{ event.organizer.username }}</div>
      </div>
      
      <div class="info-item">
        <div style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Учасники</div>
        {% if event.capacity %}
          <div style="font-size: 15px; font-weight: 500; color: var(--text);">{{ rsvp_count }} / {{ event.capacity }}</div>
          <div style="font-size: 14px; color: var(--muted); margin-top: 2px;">
            {% if remaining_places and remaining_places > 0 %}
              Вільних місць: {{ remaining_places }}
            {% else %}
              Вільних місць немає
            {% endif %}
          </div>
        {% else %}
          <div style="font-size: 15px; font-weight: 500; color: var(--text);">{{ rsvp_count }}</div>
          <div style="font-size: 14px; color: var(--muted); margin-top: 2px;">Необмежено</div>
        {% endif %}
      </div>
    </div>
    
    
    <div style="margin-bottom: 24px;">
      <a href="{{ google_calendar_url }}" target="_blank" rel="noopener noreferrer" role="button" class="outline" style="font-size: 14px; display: inline-flex; align-items: center; gap: 8px;">
        Додати в Google Calendar
      </a>
    </div>
    
    
    {% if event.status == 'cancelled' %}
      <div class="flash warning" style="margin-bottom: 24px;">
        <strong>Подію скасовано</strong><br>
        Ця подія була скасована організатором.
      </div>
    {% elif event.status == 'archived' %}
      <div class="flash info" style="margin-bottom: 24px;">
        <strong>Подія в архіві</strong><br>
        Ця подія завершилась і переміщена в архів.
      </div>
    {% endif %}
    
    
    <section style="margin-bottom: 28px;">
      <h3 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 12px; color: var(--text);">Про подію</h3>
      <div style="font-size: 15px; line-height: 1.7; color: var(--text);">{{ event.description|linebreaksbr }}</div>
    </section>
    
    
    {% if reviews_count %}
      <div style="margin-bottom: 28px; padding: 16px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 152, 0, 0.1)); border-radius: 12px; border: 1px solid rgba(255, 193, 7, 0.3);">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="font-size: 2rem;">⭐</div>
          <div>
            <div style="font-size: 1.3rem; font-weight: 700; color: var(--text);">{{ avg_rating|floatformat:1 }} / 5</div>
            <div style="font-size: 14px; color: var(--muted);">{{ reviews_count }} відгук(ів)</div>
          </div>
        </div>
      </div>
    {% endif %}
    
    
    <div class="event-actions" style="margin-bottom: 32px; display: flex; flex-wrap: wrap; gap: 12px; padding-top: 20px; border-top: 2px solid var(--border);">
      {% if user.is_authenticated %}
        {% if event.organizer == user or user.is_staff %}
          
          <a role="button" href="/events/{{ event.id }}/participants/" style="background: #3b82f6; border-color: #3b82f6;">Учасники ({{ rsvp_count }})</a>
          {% if event.status != 'archived' %}
            <a role="button" href="/events/{{ event.id }}/edit/" style="background: #60a5fa; border-color: #60a5fa;">Редагувати подію</a>
            {% if event.status != 'cancelled' %}
              <form method="post" action="/events/{{ event.id }}/cancel/" style="display:inline; margin:0;" onsubmit="return confirm('Ви впевнені, що хочете скасувати цю подію?');">
                {% csrf_token %}
                <button type="submit" class="outline" style="color: #f97373; border-color: #fca5a5; background: transparent;">Скасувати подію</button>
              </form>
            {% endif %}
          {% endif %}
          <a role="button" class="outline" href="{{ request.META.HTTP_REFERER|default:'/events/' }}" style="color: var(--muted); border-color: var(--border);">← Назад</a>
        {% else %}
        
        {% if event.status == 'cancelled' %}
          <p style="color: var(--muted);">Реєстрація недоступна - подію скасовано</p>
        {% elif user_rsvp %}
          {% if event.status == 'archived' %}
            <button disabled style="background: #dbeafe; border-color: #93c5fd; color: #1e40af;">✓ Ви відвідали цю подію</button>
          {% else %}
            <button disabled style="background: #dbeafe; border-color: #93c5fd; color: #1e40af;">✓ Ви зареєстровані</button>
            <form method="post" action="/events/{{ event.id }}/rsvp/cancel/" style="display:inline; margin:0;">
              {% csrf_token %}
              <button type="submit" class="outline" style="color: #f97373; border-color: #fca5a5; background: transparent;">Скасувати участь</button>
            </form>
          {% endif %}
        {% else %}
          {% if event_started %}
            <p style="color: var(--muted);">Реєстрація недоступна: подія вже розпочалась.</p>
          {% elif event.capacity and rsvp_count >= event.capacity %}
            <p style="color: var(--muted);">Реєстрація недоступна: всі місця зайняті.</p>
          {% else %}
            <a role="button" href="/events/{{ event.id }}/rsvp/" style="background: #3b82f6; border-color: #3b82f6;">Зареєструватися</a>
          {% endif %}
        {% endif %}
        <a role="button" class="outline" href="{{ request.META.HTTP_REFERER|default:'/events/' }}" style="color: var(--muted); border-color: var(--border);">← Назад</a>
        {% endif %}
      {% else %}
        
        <a role="button" href="/accounts/login/?next=/events/{{ event.id }}/" style="background: #3b82f6; border-color: #3b82f6;">Увійти для реєстрації</a>
        <a role="button" class="outline" href="{{ request.META.HTTP_REFERER|default:'/events/' }}" style="color: var(--muted); border-color: var(--border);">← Назад</a>
      {% endif %}
    </div>
    
    
    <section style="margin-top: 40px; padding-top: 32px; border-top: 2px solid var(--border);">
      <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; color: var(--text);">Відгуки</h2>
      {% if user.is_authenticated and can_review %}
        <div style="margin-bottom: 20px; padding: 16px; background: var(--bg); border-radius: 12px; border: 1px solid var(--border);">
          <p style="margin-bottom: 12px; font-size: 15px;">Ви були учасником цієї події і вона вже завершилась. Ви можете залишити відгук.</p>
          <a role="button" href="/events/{{ event.id }}/review/" style="font-size: 14px;">Залишити відгук</a>
        </div>
      {% elif user.is_authenticated and not can_review %}
        <p style="color: var(--muted); font-size: 14px; margin-bottom: 20px; padding: 12px; background: var(--bg); border-radius: 8px;">Відгук можуть залишити лише учасники події після її завершення, і лише один раз.</p>
      {% else %}
        <p style="color: var(--muted); font-size: 14px; margin-bottom: 20px; padding: 12px; background: var(--bg); border-radius: 8px;">Увійдіть, щоб мати можливість залишити відгук.</p>
      {% endif %}

      {% if reviews %}
        <div style="display: flex; flex-direction: column; gap: 16px;">
          {% for review in reviews %}
            <article style="padding: 20px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <header style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div>
                  <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 4px;">{{ review.user.username }}</div>
                  <div style="font-size: 13px; color: var(--muted);">{{ review.created_at|date:"d.m.Y H:i" }}</div>
                </div>
                <span style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: rgba(255, 193, 7, 0.15); border-radius: 20px; font-size: 14px; font-weight: 600; color: #f57c00;">⭐ {{ review.rating }}/5</span>
              </header>
              <div>
                {% if review.image %}
                  <img src="{{ review.image.url }}" alt="Фото з відгуку" 
                       style="float: right; width: 140px; height: 140px; object-fit: cover; border-radius: 12px; margin: 0 0 12px 16px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: transform 0.2s;" 
                       onclick="openReviewImageModal('{{ review.image.url }}')" 
                       onmouseover="this.style.transform='scale(1.05)'" 
                       onmouseout="this.style.transform='scale(1)'">
                {% endif %}
                {% if review.comment %}
                  <div style="font-size: 15px; line-height: 1.6; color: var(--text); overflow: hidden;">{{ review.comment|linebreaksbr }}</div>
                {% endif %}
                <div style="clear: both;"></div>
              </div>
            </article>
          {% empty %}
            <p style="text-align: center; color: var(--muted); padding: 40px 20px; font-size: 15px;">Ще немає жодного відгуку</p>
          {% endfor %}
        </div>
      {% else %}
        <p style="text-align: center; color: var(--muted); padding: 40px 20px; font-size: 15px;">Ще немає жодного відгуку</p>
      {% endif %}
    </section>

    <div id="review-image-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000; overflow:auto; padding:20px;">
      <div style="max-width:40vw; max-height:50vh; display:flex; justify-content:center; align-items:center;">
        <img id="review-image-modal-img" src="" alt="Фото з відгуку" style="max-width:100%; max-height:100%; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
      </div>
    </div>

    <script>
      function openReviewImageModal(src) {
        const modal = document.getElementById('review-image-modal');
        const img = document.getElementById('review-image-modal-img');
        if (modal && img) {
          img.src = src;
          modal.style.display = 'flex';
        }
      }

      document.addEventListener('click', function (e) {
        const modal = document.getElementById('review-image-modal');
        if (!modal) return;
        if (e.target === modal || e.target.id === 'review-image-modal-img') {
          modal.style.display = 'none';
        }
      });
    </script>
  </article>
{% endblock %}
