{% extends "base.html" %}
{% block title %}{{ event.title }} ¬∑ Event Organizer{% endblock %}
{% block content %}
  <article class="card">
    <header class="card-head">
      <div class="card-title">
        <h1 style="margin:0; font-size: 1.6rem;">{{ event.title }}</h1>
        <span class="badge {{ event.status }}">{{ event.get_status_display }}</span>
      </div>
    </header>
    
    <div class="event-meta" style="margin:16px 0;">
      <span>{{ event.starts_at|date:"d.m.Y H:i" }} ‚Üí {{ event.ends_at|date:"d.m.Y H:i" }}</span>
      <span>üìç {{ event.location }}</span>
      <span>üë§ –û—Ä–≥–∞–Ω—ñ–∑–∞—Ç–æ—Ä: {{ event.organizer.username }}</span>
      {% if event.capacity %}
        <span>üë• –£—á–∞—Å–Ω–∏–∫–∏: {{ rsvp_count }} / {{ event.capacity }}</span>
        <span>
          {% if remaining_places and remaining_places > 0 %}
             –í—ñ–ª—å–Ω–∏—Ö –º—ñ—Å—Ü—å: {{ remaining_places }}
          {% else %}
             –í—ñ–ª—å–Ω–∏—Ö –º—ñ—Å—Ü—å –Ω–µ–º–∞—î
          {% endif %}
        </span>
      {% else %}
        <span>üë• –£—á–∞—Å–Ω–∏–∫–∏: {{ rsvp_count }}</span>
      {% endif %}
    </div>
    
    {% if event.status == 'cancelled' %}
      <div class="flash warning" style="margin:16px 0;">
        <strong>–ü–æ–¥—ñ—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ</strong><br>
        –¶—è –ø–æ–¥—ñ—è –±—É–ª–∞ —Å–∫–∞—Å–æ–≤–∞–Ω–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ç–æ—Ä–æ–º.
      </div>
    {% elif event.status == 'archived' %}
      <div class="flash info" style="margin:16px 0;">
        <strong>–ü–æ–¥—ñ—è –≤ –∞—Ä—Ö—ñ–≤—ñ</strong><br>
        –¶—è –ø–æ–¥—ñ—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —ñ –ø–µ—Ä–µ–º—ñ—â–µ–Ω–∞ –≤ –∞—Ä—Ö—ñ–≤.
      </div>
    {% endif %}
    
    <p style="margin:16px 0;">{{ event.description|linebreaksbr }}</p>
    
    {% if reviews_count %}
      <div class="flash info" style="margin:16px 0;">
        <strong>–†–µ–π—Ç–∏–Ω–≥ –ø–æ–¥—ñ—ó:</strong>
        ‚≠ê {{ avg_rating|floatformat:1 }} / 5 ¬∑ {{ reviews_count }} –≤—ñ–¥–≥—É–∫(—ñ–≤)
      </div>
    {% endif %}
    
    <div class="event-actions" style="margin-bottom: 16px;">
      {% if user.is_authenticated %}
        {% if event.organizer == user or user.is_staff %}
          <!-- –û—Ä–≥–∞–Ω—ñ–∑–∞—Ç–æ—Ä —Ç–∞ –∞–¥–º—ñ–Ω –±–∞—á–∞—Ç—å –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–∞ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è -->
          <a role="button" href="/events/{{ event.id }}/participants/">üë• –£—á–∞—Å–Ω–∏–∫–∏ ({{ rsvp_count }})</a>
          {% if event.status != 'archived' %}
            <a role="button" href="/events/{{ event.id }}/edit/">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ–¥—ñ—é</a>
            {% if event.status != 'cancelled' %}
              <form method="post" action="/events/{{ event.id }}/cancel/" style="display:inline; margin:0;" onsubmit="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ —Ü—é –ø–æ–¥—ñ—é?');">
                {% csrf_token %}
                <button type="submit" class="outline" style="background:#dc3545; border-color:#dc3545; color:#fff;">–°–∫–∞—Å—É–≤–∞—Ç–∏ –ø–æ–¥—ñ—é</button>
              </form>
            {% endif %}
          {% endif %}
          <a role="button" class="outline" href="/">‚Üê –ù–∞–∑–∞–¥</a>
        {% else %}
        <!-- –ó–≤–∏—á–∞–π–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –±–∞—á–∞—Ç—å RSVP -->
        {% if event.status == 'cancelled' %}
          <p style="color: var(--muted);">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ - –ø–æ–¥—ñ—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ</p>
        {% elif user_rsvp %}
          {% if event.status == 'archived' %}
            <button disabled class="rsvp-registered">‚úì –í–∏ –≤—ñ–¥–≤—ñ–¥–∞–ª–∏ —Ü—é –ø–æ–¥—ñ—é</button>
          {% else %}
            <button disabled class="rsvp-registered">‚úì –í–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ</button>
            <form method="post" action="/events/{{ event.id }}/rsvp/cancel/" style="display:inline; margin:0;">
              {% csrf_token %}
              <button type="submit" class="outline">–°–∫–∞—Å—É–≤–∞—Ç–∏ —É—á–∞—Å—Ç—å</button>
            </form>
          {% endif %}
        {% else %}
          {% if event_started %}
            <p style="color: var(--muted);">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: –ø–æ–¥—ñ—è –≤–∂–µ —Ä–æ–∑–ø–æ—á–∞–ª–∞—Å—å.</p>
          {% elif event.capacity and rsvp_count >= event.capacity %}
            <p style="color: var(--muted);">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: –≤—Å—ñ –º—ñ—Å—Ü—è –∑–∞–π–Ω—è—Ç—ñ.</p>
          {% else %}
            <a role="button" href="/events/{{ event.id }}/rsvp/">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</a>
          {% endif %}
        {% endif %}
        <a role="button" class="outline" href="/">‚Üê –ù–∞–∑–∞–¥</a>
        {% endif %}
      {% else %}
        <!-- –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ -->
        <a role="button" href="/accounts/login/?next=/events/{{ event.id }}/">–£–≤—ñ–π—Ç–∏ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó</a>
        <a role="button" class="outline" href="/">‚Üê –ù–∞–∑–∞–¥</a>
      {% endif %}
    </div>
    
    <hr style="margin:24px 0;">
    
    <section>
      <h2>–í—ñ–¥–≥—É–∫–∏</h2>
      {% if user.is_authenticated and can_review %}
        <p>–í–∏ –±—É–ª–∏ —É—á–∞—Å–Ω–∏–∫–æ–º —Ü—ñ—î—ó –ø–æ–¥—ñ—ó —ñ –≤–æ–Ω–∞ –≤–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å. –í–∏ –º–æ–∂–µ—Ç–µ –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫.</p>
        <a role="button" href="/events/{{ event.id }}/review/">–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</a>
      {% elif user.is_authenticated and not can_review %}
        <p style="color: var(--muted); font-size: 14px;">–í—ñ–¥–≥—É–∫ –º–æ–∂—É—Ç—å –∑–∞–ª–∏—à–∏—Ç–∏ –ª–∏—à–µ —É—á–∞—Å–Ω–∏–∫–∏ –ø–æ–¥—ñ—ó –ø—ñ—Å–ª—è —ó—ó –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è, —ñ –ª–∏—à–µ –æ–¥–∏–Ω —Ä–∞–∑.</p>
      {% else %}
        <p style="color: var(--muted); font-size: 14px;">–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –º–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫.</p>
      {% endif %}

      {% if reviews %}
        <div style="margin-top:16px; display:flex; flex-direction:column; gap:12px;">
          {% for review in reviews %}
            <article class="card" style="margin:0;">
              <header class="card-head">
                <div class="card-title">
                  <strong>{{ review.user.username }}</strong>
                  <span class="badge">‚≠ê {{ review.rating }}/5</span>
                </div>
                <small class="muted">{{ review.created_at|date:"d.m.Y H:i" }}</small>
              </header>
              {% if review.comment %}
                <p style="margin-top:8px;">{{ review.comment|linebreaksbr }}</p>
              {% endif %}
            </article>
          {% empty %}
            <p>–©–µ –Ω–µ–º–∞—î –∂–æ–¥–Ω–æ–≥–æ –≤—ñ–¥–≥—É–∫—É.</p>
          {% endfor %}
        </div>
      {% else %}
        <p style="margin-top:8px;">–©–µ –Ω–µ–º–∞—î –∂–æ–¥–Ω–æ–≥–æ –≤—ñ–¥–≥—É–∫—É.</p>
      {% endif %}
    </section>
  </article>
{% endblock %}
