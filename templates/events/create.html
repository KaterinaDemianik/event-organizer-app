{% extends "base.html" %}
{% block title %}–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ–¥—ñ—é ¬∑ Event Organizer{% endblock %}

{% block content %}
  <div style="max-width: var(--content-width); width: 100%; margin: 0 auto; padding: 20px 0;">
    <article class="card" style="padding: 40px; width: 100%;">
      <h2 style="margin: 0 0 24px 0; font-size: 28px; font-weight: 600;">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–¥—ñ—ó</h2>
      {% if not user.is_authenticated %}
        <p>–ü–æ—Ç—Ä—ñ–±–µ–Ω –≤—Ö—ñ–¥ —É —Å–∏—Å—Ç–µ–º—É. <a href="/accounts/login/?next=/events/create/">–£–≤—ñ–π—Ç–∏</a></p>
      {% else %}
        {% if not user.is_staff %}
          <div class="flash info" style="margin-bottom: 16px;">
            <strong>–û—Ä–≥–∞–Ω—ñ–∑–∞—Ç–æ—Ä:</strong> {{ user.username }}
          </div>
        {% endif %}
        <form method="post" id="event-form">
          {% csrf_token %}
          
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 16px 0; color: var(--muted);">–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>
            <fieldset>
              {{ form.as_p }}
            </fieldset>
          </div>
          
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 12px 0; color: var(--muted);">–ú—ñ—Å—Ü–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è</h3>
            
            <div style="display: flex; gap: 8px; margin-bottom: 12px; align-items: stretch;">
              <input type="text" id="address-search" placeholder="–í–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –•—Ä–µ—â–∞—Ç–∏–∫ 22, –ö–∏—ó–≤)" style="flex: 1; height: 44px; min-height: 44px; max-height: 44px; box-sizing: border-box;" />
              <button type="button" onclick="searchAddress()" style="white-space: nowrap; height: 44px; min-height: 44px; max-height: 44px;">üîç –ó–Ω–∞–π—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç—ñ</button>
            </div>
            
            <div id="location-map" style="width: 100%; height: 400px; border: 1px solid var(--border); border-radius: 12px; position: relative; z-index: 1; overflow: hidden;"></div>
            <p style="font-size: 13px; color: var(--muted); margin-top: 10px;">
              –í–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É –≤–∏—â–µ –∞–±–æ –∫–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—ñ, —â–æ–± –≤–∏–±—Ä–∞—Ç–∏ –º—ñ—Å—Ü–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –ø–æ–¥—ñ—ó.
              <span id="coords-display" style="font-weight: 600; color: var(--link);"></span>
            </p>
          </div>
          
          <div style="display: flex; gap: 12px; padding-top: 8px; border-top: 1px solid var(--border); margin-top: 24px; padding-top: 24px;">
            <button type="submit" style="flex: 1;">–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ–¥—ñ—é</button>
            <a role="button" class="outline" href="/" style="flex: 0 0 auto;">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
          </div>
        </form>
      {% endif %}
    </article>
  </div>
  
  <script>
    var eventMap, eventMarker;
    
    function initEventMap() {
      var mapEl = document.getElementById('location-map');
      if (!mapEl) return;
      
      var latInput = document.getElementById('id_latitude');
      var lngInput = document.getElementById('id_longitude');
      var coordsDisplay = document.getElementById('coords-display');
      
      if (!latInput || !lngInput) return;
      
      var defaultLat = 50.4501;
      var defaultLng = 30.5234;
      
      eventMap = L.map('location-map').setView([defaultLat, defaultLng], 11);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
      }).addTo(eventMap);
      
      eventMarker = null;
      
      // –ö–∞—Å—Ç–æ–º–Ω–∞ —ñ–∫–æ–Ω–∫–∞ –∑ emoji
      var eventIcon = L.divIcon({
        html: '<div style="font-size: 32px; line-height: 1;">‚≠ê</div>',
        className: 'custom-event-marker',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });

      if (latInput.value && lngInput.value) {
        var lat = parseFloat(latInput.value);
        var lng = parseFloat(lngInput.value);
        eventMarker = L.marker([lat, lng], { icon: eventIcon }).addTo(eventMap);
        eventMap.setView([lat, lng], 13);
        coordsDisplay.textContent = '–û–±—Ä–∞–Ω–æ: ' + lat.toFixed(4) + ', ' + lng.toFixed(4);
      }
      
      eventMap.on('click', function(e) {
        setMapLocation(e.latlng.lat, e.latlng.lng);
      });
    }
    
    function setMapLocation(lat, lng) {
      var latInput = document.getElementById('id_latitude');
      var lngInput = document.getElementById('id_longitude');
      var coordsDisplay = document.getElementById('coords-display');
      
      latInput.value = lat;
      lngInput.value = lng;
      coordsDisplay.textContent = '–û–±—Ä–∞–Ω–æ: ' + lat.toFixed(4) + ', ' + lng.toFixed(4);
      
      if (eventMarker) {
        eventMap.removeLayer(eventMarker);
      }
      
      var eventIcon = L.divIcon({
        html: '<div style="font-size: 32px; line-height: 1;">‚≠ê</div>',
        className: 'custom-event-marker',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });
      
      eventMarker = L.marker([lat, lng], { icon: eventIcon }).addTo(eventMap);
      eventMap.setView([lat, lng], 15);
    }
    
    function searchAddress() {
      var addressInput = document.getElementById('address-search');
      var address = addressInput.value.trim();
      
      if (!address) {
        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É');
        return;
      }
      
      var coordsDisplay = document.getElementById('coords-display');
      coordsDisplay.textContent = '–®—É–∫–∞—î–º–æ...';
      
      // Nominatim API –¥–ª—è –≥–µ–æ–∫–æ–¥—É–≤–∞–Ω–Ω—è
      var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(address) + '&limit=1';
      
      fetch(url, {
        headers: {
          'Accept': 'application/json'
        }
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        if (data && data.length > 0) {
          var lat = parseFloat(data[0].lat);
          var lng = parseFloat(data[0].lon);
          setMapLocation(lat, lng);
        } else {
          alert('–ê–¥—Ä–µ—Å—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –∑–∞–ø–∏—Ç.');
          coordsDisplay.textContent = '';
        }
      })
      .catch(function(error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–æ—à—É–∫—É –∞–¥—Ä–µ—Å–∏. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
        coordsDisplay.textContent = '';
      });
    }
    
    // –ß–µ–∫–∞—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è Leaflet
    if (typeof L !== 'undefined') {
      initEventMap();
    } else {
      window.addEventListener('load', initEventMap);
    }
  </script>
{% endblock %}
