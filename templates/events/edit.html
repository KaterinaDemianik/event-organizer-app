{% extends "base.html" %}
{% block title %}Редагувати подію · Event Organizer{% endblock %}

{% block content %}
  <div style="max-width: var(--content-width); width: 100%; margin: 0 auto; padding: 20px 0;">
    <article class="card" style="padding: 40px; width: 100%;">
      <h2 style="margin: 0 0 24px 0; font-size: 28px; font-weight: 600;">Редагування події</h2>
      {% if not user.is_staff %}
        <div class="flash info" style="margin-bottom: 16px;">
          <strong>Організатор:</strong> {{ event.organizer.username }}
        </div>
      {% endif %}
      <form method="post" id="event-form">
        {% csrf_token %}
        
        <div style="margin-bottom: 24px;">
          <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 16px 0; color: var(--muted);">Основна інформація</h3>
          <fieldset>
            {{ form.latitude }}
            {{ form.longitude }}
            {% if form.organizer %}
              <p>
                {{ form.organizer.label_tag }}
                {{ form.organizer }}
                {% if form.organizer.errors %}
                  <span style="color: #dc3545; font-size: 13px;">{{ form.organizer.errors }}</span>
                {% endif %}
              </p>
            {% endif %}
            
            <p>
              {{ form.title.label_tag }}
              {{ form.title }}
              {% if form.title.errors %}
                <span style="color: #dc3545; font-size: 13px;">{{ form.title.errors }}</span>
              {% endif %}
            </p>
            
            <p>
              {{ form.description.label_tag }}
              {{ form.description }}
              {% if form.description.errors %}
                <span style="color: #dc3545; font-size: 13px;">{{ form.description.errors }}</span>
              {% endif %}
            </p>
            
            <p>
              {{ form.location.label_tag }}
              {{ form.location }}
              {% if form.location.errors %}
                <span style="color: #dc3545; font-size: 13px;">{{ form.location.errors }}</span>
              {% endif %}
            </p>
            
            <div class="event-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <p>
                {{ form.starts_at.label_tag }}
                {{ form.starts_at }}
                {% if form.starts_at.errors %}
                  <span style="color: #dc3545; font-size: 13px;">{{ form.starts_at.errors }}</span>
                {% endif %}
              </p>
              
              <p>
                {{ form.ends_at.label_tag }}
                {{ form.ends_at }}
                {% if form.ends_at.errors %}
                  <span style="color: #dc3545; font-size: 13px;">{{ form.ends_at.errors }}</span>
                {% endif %}
              </p>
              
              <p>
                {{ form.status.label_tag }}
                {{ form.status }}
                {% if form.status.errors %}
                  <span style="color: #dc3545; font-size: 13px;">{{ form.status.errors }}</span>
                {% endif %}
              </p>
              
              <p>
                {{ form.category.label_tag }}
                {{ form.category }}
                {% if form.category.errors %}
                  <span style="color: #dc3545; font-size: 13px;">{{ form.category.errors }}</span>
                {% endif %}
              </p>
              
              <p style="grid-column: 1 / -1;">
                {{ form.capacity.label_tag }}
                {{ form.capacity }}
                {% if form.capacity.errors %}
                  <span style="color: #dc3545; font-size: 13px;">{{ form.capacity.errors }}</span>
                {% endif %}
                {% if form.capacity.help_text %}
                  <small style="display: block; color: var(--muted); font-size: 13px; margin-top: 4px;">{{ form.capacity.help_text }}</small>
                {% endif %}
              </p>
            </div>
          </fieldset>
        </div>
        
        <div style="margin-bottom: 24px;">
          <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 12px 0; color: var(--muted);">Місце проведення</h3>
          
          <div style="display: flex; gap: 8px; margin-bottom: 12px; align-items: stretch;">
            <input type="text" id="address-search" placeholder="Введіть адресу (наприклад: Хрещатик 22, Київ)" style="flex: 1; height: 44px; min-height: 44px; max-height: 44px; box-sizing: border-box;" />
            <button type="button" onclick="searchAddress()" style="white-space: nowrap; height: 44px; min-height: 44px; max-height: 44px;">Знайти на карті</button>
          </div>
          
          <div id="location-map" style="width: 100%; height: 400px; border: 1px solid var(--border); border-radius: 12px; position: relative; z-index: 1; overflow: hidden;"></div>
          <p style="font-size: 13px; color: var(--muted); margin-top: 10px;">
            Введіть адресу вище або клікніть на карті, щоб вибрати місце проведення події.
            <span id="coords-display" style="font-weight: 600; color: var(--link);"></span>
          </p>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: center; padding-top: 8px; border-top: 1px solid var(--border); margin-top: 24px; padding-top: 24px;">
          <button type="submit" style="width: auto !important; min-width: auto; flex: 0 0 auto;">Зберегти зміни</button>
          <a role="button" class="outline" href="/events/{{ event.id }}/" style="width: auto !important; min-width: auto; flex: 0 0 auto;">Скасувати</a>
        </div>
      </form>
    </article>
  </div>
  
  <script>
    var eventMap, eventMarker;
    
    function initEventMap() {
      var mapEl = document.getElementById('location-map');
      if (!mapEl) return;
      
      var latInput = document.getElementById('id_latitude');
      var lngInput = document.getElementById('id_longitude');
      var coordsDisplay = document.getElementById('coords-display');
      
      if (!latInput || !lngInput) return;
      
      var defaultLat = 50.4501;
      var defaultLng = 30.5234;
      
      eventMap = L.map('location-map').setView([defaultLat, defaultLng], 11);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(eventMap);
      
      eventMarker = null;
      
      // Кастомна іконка з emoji
      var eventIcon = L.divIcon({
        html: '<div style="font-size: 32px; line-height: 1;">⭐</div>',
        className: 'custom-event-marker',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });

      if (latInput.value && lngInput.value) {
        var lat = parseFloat(latInput.value);
        var lng = parseFloat(lngInput.value);
        eventMarker = L.marker([lat, lng], { icon: eventIcon }).addTo(eventMap);
        eventMap.setView([lat, lng], 13);
        coordsDisplay.textContent = 'Обрано: ' + lat.toFixed(4) + ', ' + lng.toFixed(4);
      }
      
      eventMap.on('click', function(e) {
        setMapLocation(e.latlng.lat, e.latlng.lng);
      });
    }
    
    function setMapLocation(lat, lng) {
      var latInput = document.getElementById('id_latitude');
      var lngInput = document.getElementById('id_longitude');
      var coordsDisplay = document.getElementById('coords-display');
      
      latInput.value = lat;
      lngInput.value = lng;
      coordsDisplay.textContent = 'Обрано: ' + lat.toFixed(4) + ', ' + lng.toFixed(4);
      
      if (eventMarker) {
        eventMap.removeLayer(eventMarker);
      }
      
      var eventIcon = L.divIcon({
        html: '<div style="font-size: 32px; line-height: 1;">⭐</div>',
        className: 'custom-event-marker',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });
      
      eventMarker = L.marker([lat, lng], { icon: eventIcon }).addTo(eventMap);
      eventMap.setView([lat, lng], 15);
    }
    
    function searchAddress() {
      var addressInput = document.getElementById('address-search');
      var address = addressInput.value.trim();
      
      if (!address) {
        alert('Будь ласка, введіть адресу');
        return;
      }
      
      var coordsDisplay = document.getElementById('coords-display');
      coordsDisplay.textContent = 'Шукаємо...';
      
      // Nominatim API для геокодування
      var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(address) + '&limit=1';
      
      fetch(url, {
        headers: {
          'Accept': 'application/json'
        }
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        if (data && data.length > 0) {
          var lat = parseFloat(data[0].lat);
          var lng = parseFloat(data[0].lon);
          setMapLocation(lat, lng);
        } else {
          alert('Адресу не знайдено. Спробуйте інший запит.');
          coordsDisplay.textContent = '';
        }
      })
      .catch(function(error) {
        console.error('Помилка пошуку:', error);
        alert('Помилка при пошуку адреси. Спробуйте ще раз.');
        coordsDisplay.textContent = '';
      });
    }
    
    // Чекаємо завантаження Leaflet
    if (typeof L !== 'undefined') {
      initEventMap();
    } else {
      window.addEventListener('load', initEventMap);
    }
  </script>
{% endblock %}
