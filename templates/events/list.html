{% extends "base.html" %}
{% block title %}–ü–æ–¥—ñ—ó ¬∑ Event Organizer{% endblock %}
{% block content %}
  <h2>–ü–æ–¥—ñ—ó</h2>

  <!-- Tabs Navigation -->
  <div class="tabs-nav">
    <a href="/events/?view=all" class="tab-link {% if view == 'all' or not view %}active{% endif %}">–í—Å—ñ –ø–æ–¥—ñ—ó</a>
    {% if user.is_authenticated %}
      <a href="/events/?view=my" class="tab-link {% if view == 'my' %}active{% endif %}">–ú–æ—ó –ø–æ–¥—ñ—ó</a>
      <a href="/events/?view=upcoming" class="tab-link {% if view == 'upcoming' %}active{% endif %}">–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ</a>
      <a href="/events/?view=archived" class="tab-link {% if view == 'archived' %}active{% endif %}">–ê—Ä—Ö—ñ–≤</a>
    {% endif %}
  </div>

  {% if view != 'archived' %}
    <div id="events-map" class="card" style="height: 380px; margin-bottom: 16px; padding: 0; overflow: hidden;"></div>
  {% endif %}

  <div class="filters-card card">
    <form method="get">
      <input type="hidden" name="view" value="{{ view }}" />
      
      <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 12px; align-items: end;">
        <div>
          <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–ü–æ—à—É–∫</label>
          <input type="search" name="q" value="{{ q }}" placeholder="–ü–æ—à—É–∫..." />
        </div>
        
        <div>
          <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–°—Ç–∞—Ç—É—Å</label>
          <select name="status">
            <option value="">–í—Å—ñ</option>
            {% for val,label in status_choices %}
              <option value="{{ val }}" {% if status == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div>
          <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
          <input type="search" name="category" value="{{ category }}" />
        </div>
        
        <div>
          <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–î–∞—Ç–∞</label>
          <select name="date_filter">
            <option value="">–í—Å—ñ</option>
            <option value="upcoming" {% if date_filter == 'upcoming' %}selected{% endif %}>–ú–∞–π–±—É—Ç–Ω—ñ</option>
            <option value="today" {% if date_filter == 'today' %}selected{% endif %}>–°—å–æ–≥–æ–¥–Ω—ñ</option>
            <option value="this_week" {% if date_filter == 'this_week' %}selected{% endif %}>–¶–µ–π —Ç–∏–∂–¥–µ–Ω—å</option>
            <option value="this_month" {% if date_filter == 'this_month' %}selected{% endif %}>–¶–µ–π –º—ñ—Å—è—Ü—å</option>
          </select>
        </div>
        
        <div>
          <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–ü–æ–ø—É–ª—è—Ä–Ω—ñ—Å—Ç—å</label>
          <select name="popularity">
            <option value="">–í—Å—ñ</option>
            <option value="popular" {% if popularity == 'popular' %}selected{% endif %}>–ü–æ–ø—É–ª—è—Ä–Ω—ñ (5+)</option>
            <option value="medium" {% if popularity == 'medium' %}selected{% endif %}>–°–µ—Ä–µ–¥–Ω—ñ (1-4)</option>
            <option value="none" {% if popularity == 'none' %}selected{% endif %}>–ë–µ–∑ RSVP</option>
          </select>
        </div>

        <div>
          <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–ú—ñ—Å—Ü—è</label>
          <select name="availability">
            <option value="">–í—Å—ñ</option>
            <option value="available" {% if availability == 'available' %}selected{% endif %}>–Ñ –º—ñ—Å—Ü—è</option>
            <option value="full" {% if availability == 'full' %}selected{% endif %}>–ù–µ–º–∞—î –º—ñ—Å—Ü—å</option>
          </select>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px;">
        <div>
          <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è</label>
          <select name="sort">
            <option value="date" {% if sort == 'date' or not sort %}selected{% endif %}>–ó–∞ –¥–∞—Ç–æ—é —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è</option>
            <option value="popular" {% if sort == 'popular' %}selected{% endif %}>–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—ñ</option>
            <option value="alphabet" {% if sort == 'alphabet' %}selected{% endif %}>–ó–∞ –∞–ª—Ñ–∞–≤—ñ—Ç–æ–º</option>
            <option value="event_date" {% if sort == 'event_date' %}selected{% endif %}>–ü–æ –¥–∞—Ç—ñ –ø–æ–¥—ñ—ó</option>
            <option value="rsvp_count" {% if sort == 'rsvp_count' %}selected{% endif %}>–ü–æ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ RSVP</option>
          </select>
        </div>
        
        <div style="display: flex; gap: 8px; padding-top: 26px;">
          <button type="submit">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
          {% if q or status or category or date_filter or popularity or availability or sort != 'date' %}
            <a role="button" class="secondary" href="/events/?view={{ view }}">–°–∫–∏–Ω—É—Ç–∏</a>
          {% endif %}
        </div>
      </div>
    </form>
  </div>
  
  {% if popular_tags %}
    <div class="popular-tags" style="margin: 12px 0 20px 0; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
      <span style="font-size: 13px; color: var(--muted);">–ü–æ–ø—É–ª—è—Ä–Ω—ñ —Ç–µ–≥–∏:</span>
      <form method="get" style="display: flex; flex-wrap: wrap; gap: 8px; margin: 0;">
        <input type="hidden" name="view" value="{{ view }}" />
        {% if q %}<input type="hidden" name="q" value="{{ q }}" />{% endif %}
        {% if status %}<input type="hidden" name="status" value="{{ status }}" />{% endif %}
        {% if date_filter %}<input type="hidden" name="date_filter" value="{{ date_filter }}" />{% endif %}
        {% if popularity %}<input type="hidden" name="popularity" value="{{ popularity }}" />{% endif %}
        {% if availability %}<input type="hidden" name="availability" value="{{ availability }}" />{% endif %}
        {% if sort %}<input type="hidden" name="sort" value="{{ sort }}" />{% endif %}
        {% for tag in popular_tags %}
          <button type="submit" name="category" value="{{ tag.slug }}" class="tag-pill{% if category == tag.slug %} active{% endif %}"># {{ tag.label }} ({{ tag.count }})</button>
        {% endfor %}
      </form>
      {% if category %}
        <a href="/events/?view={{ view }}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if date_filter %}&date_filter={{ date_filter }}{% endif %}{% if popularity %}&popularity={{ popularity }}{% endif %}{% if availability %}&availability={{ availability }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" 
           style="font-size: 13px; color: var(--link); text-decoration: none; white-space: nowrap; font-weight: 500;">
          √ó –ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ
        </a>
      {% endif %}
    </div>
  {% endif %}

  {% if events %}
    <div class="grid">
      {% for e in events %}
        <article class="card">
          <header class="card-head">
            <div class="card-title">
              <h3><a href="/events/{{ e.id }}/">{{ e.title }}</a></h3>
              <span class="badge {{ e.status }}">{{ e.get_status_display|default:e.status }}</span>
            </div>
            <small class="muted">{{ e.starts_at|date:"d.m.Y H:i" }} ‚Üí {{ e.ends_at|date:"d.m.Y H:i" }}</small>
            <div style="display:flex; gap:12px; flex-wrap:wrap;">
              {% if e.location %}<small class="muted">üìç {{ e.location }}</small>{% endif %}
              <small class="muted">üë§ {{ e.organizer.username }}</small>
              {% if e.category %}<small class="muted">üè∑Ô∏è {{ e.category }}</small>{% endif %}
              {% if e.capacity %}
                <small class="muted">üë• {{ e.rsvp_count }} / {{ e.capacity }} –º—ñ—Å—Ü—å</small>
              {% else %}
                <small class="muted">üë• {{ e.rsvp_count }} RSVP</small>
              {% endif %}
            </div>
          </header>
          <p>{{ e.description|truncatechars:160 }}</p>
          <footer class="card-actions">
            <a role="button" href="/events/{{ e.id }}/">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ</a>
            {% if user.is_authenticated %}
              {% if e.organizer == user or user.is_staff %}
                {% if e.status != 'archived' %}
                  <a role="button" class="outline" href="/events/{{ e.id }}/edit/">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                {% endif %}
              {% endif %}
            {% endif %}
          </footer>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <article class="empty">
      <p>–ü–æ–∫–∏ —â–æ –ø–æ–¥—ñ–π –Ω–µ–º–∞—î.</p>
      <a role="button" href="/events/create/">–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–µ—Ä—à—É</a>
    </article>
  {% endif %}

  {% if is_paginated %}
    <nav class="pagination" aria-label="Pagination">
      <ul>
        {% if page_obj.has_previous %}
          <li><a href="?page=1{% if view %}&view={{ view }}{% endif %}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if location %}&location={{ location }}{% endif %}{% if popularity %}&popularity={{ popularity }}{% endif %}{% if availability %}&availability={{ availability }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">&laquo; –ü–µ—Ä—à–∞</a></li>
          <li><a href="?page={{ page_obj.previous_page_number }}{% if view %}&view={{ view }}{% endif %}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if location %}&location={{ location }}{% endif %}{% if popularity %}&popularity={{ popularity }}{% endif %}{% if availability %}&availability={{ availability }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">‚Üê –ü–æ–ø–µ—Ä–µ–¥–Ω—è</a></li>
        {% endif %}
        
        <li class="current">–°—Ç–æ—Ä—ñ–Ω–∫–∞ {{ page_obj.number }} –∑ {{ page_obj.paginator.num_pages }}</li>
        
        {% if page_obj.has_next %}
          <li><a href="?page={{ page_obj.next_page_number }}{% if view %}&view={{ view }}{% endif %}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if location %}&location={{ location }}{% endif %}{% if popularity %}&popularity={{ popularity }}{% endif %}{% if availability %}&availability={{ availability }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">–ù–∞—Å—Ç—É–ø–Ω–∞ ‚Üí</a></li>
          <li><a href="?page={{ page_obj.paginator.num_pages }}{% if view %}&view={{ view }}{% endif %}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if location %}&location={{ location }}{% endif %}{% if popularity %}&popularity={{ popularity }}{% endif %}{% if availability %}&availability={{ availability }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">–û—Å—Ç–∞–Ω–Ω—è &raquo;</a></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

  {% if view != 'archived' %}
  <script>
    (function() {
      var mapContainer = document.getElementById('events-map');
      if (!mapContainer) return;

      // –ó–±–∏—Ä–∞—î–º–æ –ø–æ–¥—ñ—ó –∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
      var eventsData = [
        {% for e in events %}
          {% if e.latitude and e.longitude %}
            {
              title: "{{ e.title|escapejs }}",
              lat: {{ e.latitude|floatformat:"6" }},
              lng: {{ e.longitude|floatformat:"6" }},
              url: "/events/{{ e.id }}/"
            },
          {% endif %}
        {% endfor %}
      ];

      if (eventsData.length === 0) {
        mapContainer.style.display = 'none';
        return;
      }

      if (typeof L === 'undefined') {
        console.error('Leaflet –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
        mapContainer.style.display = 'none';
        return;
      }

      var map = L.map('events-map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
      }).addTo(map);

      // –ö–∞—Å—Ç–æ–º–Ω–∞ —ñ–∫–æ–Ω–∫–∞ –∑ emoji
      var eventIcon = L.divIcon({
        html: '<div style="font-size: 32px; line-height: 1;">‚≠ê</div>',
        className: 'custom-event-marker',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });

      var markers = [];
      eventsData.forEach(function(ev) {
        var marker = L.marker([ev.lat, ev.lng], { icon: eventIcon }).addTo(map);
        marker.bindPopup('<strong>' + ev.title + '</strong><br><a href="' + ev.url + '">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ</a>');
        markers.push(marker);
      });

      if (markers.length > 0) {
        var group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
      }
    })();
  </script>
  {% endif %}
{% endblock %}
