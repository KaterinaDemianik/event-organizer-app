{% extends "base.html" %}
{% block title %}–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å ¬∑ Event Organizer{% endblock %}
{% block content %}
  <h2> –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞ –ø–∞–Ω–µ–ª—å</h2>

  <!-- –í–∫–ª–∞–¥–∫–∏ -->
  <div class="tabs-nav">
    <a href="/?tab=stats" class="tab-link {% if tab == 'stats' or not tab %}active{% endif %}">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
    <a href="/?tab=events" class="tab-link {% if tab == 'events' %}active{% endif %}">–ü–æ–¥—ñ—ó</a>
    <a href="/?tab=users" class="tab-link {% if tab == 'users' %}active{% endif %}">üë• –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</a>
    <a href="/?tab=rsvps" class="tab-link {% if tab == 'rsvps' %}active{% endif %}">üìù RSVP</a>
  </div>

  {% if tab == 'stats' or not tab %}
  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  
  <!-- –§—ñ–ª—å—Ç—Ä –ø–µ—Ä—ñ–æ–¥—É -->
  <div class="filters-card card" style="margin-bottom: 24px;">
    <form method="get">
      <input type="hidden" name="tab" value="stats" />
      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px;">
        <div>
          <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–®–≤–∏–¥–∫–∏–π –≤–∏–±—ñ—Ä</label>
          <select name="period" id="period-select">
            <option value="all" {% if period == 'all' or not period %}selected{% endif %}>–ó–∞ –≤–µ—Å—å —á–∞—Å</option>
            <option value="today" {% if period == 'today' %}selected{% endif %}>–°—å–æ–≥–æ–¥–Ω—ñ</option>
            <option value="week" {% if period == 'week' %}selected{% endif %}>–ó–∞ —Ç–∏–∂–¥–µ–Ω—å</option>
            <option value="month" {% if period == 'month' %}selected{% endif %}>–ó–∞ –º—ñ—Å—è—Ü—å</option>
            <option value="quarter" {% if period == 'quarter' %}selected{% endif %}>–ó–∞ –∫–≤–∞—Ä—Ç–∞–ª</option>
            <option value="year" {% if period == 'year' %}selected{% endif %}>–ó–∞ —Ä—ñ–∫</option>
            <option value="custom" {% if period == 'custom' %}selected{% endif %}>–í–ª–∞—Å–Ω–∏–π –ø–µ—Ä—ñ–æ–¥</option>
          </select>
        </div>
        
        <div>
          <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–í—ñ–¥</label>
          <input type="date" name="date_from" value="{{ date_from }}" id="date-from" />
        </div>
        
        <div>
          <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–î–æ</label>
          <input type="date" name="date_to" value="{{ date_to }}" id="date-to" />
        </div>
        
        <div style="padding-top: 26px; display: flex; gap: 8px;">
          <button type="submit">–û–Ω–æ–≤–∏—Ç–∏</button>
          {% if date_from or date_to or period and period != 'all' %}
            <a role="button" class="secondary" href="/?tab=stats">–°–∫–∏–Ω—É—Ç–∏</a>
          {% endif %}
        </div>
      </div>
    </form>
  </div>
  
  <script>
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—î–º–æ –Ω–∞ "–í–ª–∞—Å–Ω–∏–π –ø–µ—Ä—ñ–æ–¥" –ø—Ä–∏ –∑–º—ñ–Ω—ñ –¥–∞—Ç
    document.getElementById('date-from')?.addEventListener('change', function() {
      document.getElementById('period-select').value = 'custom';
    });
    document.getElementById('date-to')?.addEventListener('change', function() {
      document.getElementById('period-select').value = 'custom';
    });
  </script>
  
  {% if period and period != 'all' %}
    <p style="margin: 16px 0; color: var(--muted); text-align: center;">
      –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ <strong>{{ stats.period_label }}</strong>
    </p>
  {% endif %}
  
  <div class="stats-grid">
    <div class="stat-card">
      <h3>–ü–æ–¥—ñ—ó</h3>
      <div class="stat-number">{{ stats.total_events }}</div>
      <div class="stat-details">
        <span>–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ: {{ stats.published_events }}</span>
        <span>–ú–∞–π–±—É—Ç–Ω—ñ: {{ stats.upcoming_events }}</span>
        <span>–í –∞—Ä—Ö—ñ–≤—ñ: {{ stats.archived_events }}</span>
      </div>
    </div>

    <div class="stat-card">
      <h3>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</h3>
      <div class="stat-number">{{ stats.total_users }}</div>
      <div class="stat-details">
        <span>–ù–æ–≤–∏—Ö –∑–∞ —Ç–∏–∂–¥–µ–Ω—å: +{{ stats.new_users_week }}</span>
        <span>–ù–æ–≤–∏—Ö –∑–∞ –º—ñ—Å—è—Ü—å: +{{ stats.new_users_month }}</span>
      </div>
    </div>

    <div class="stat-card">
      <h3>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó (RSVP)</h3>
      <div class="stat-number">{{ stats.total_rsvps }}</div>
      <div class="stat-details">
        <span>–ó–∞ —Ç–∏–∂–¥–µ–Ω—å: +{{ stats.rsvps_week }}</span>
        <span>–ó–∞ –º—ñ—Å—è—Ü—å: +{{ stats.rsvps_month }}</span>
      </div>
    </div>
  </div>

  <!-- –¢–æ–ø –ø–æ–¥—ñ—ó -->
  <div class="admin-section">
    <h2>–¢–æ–ø –ø–æ–¥—ñ—ó –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—ñ</h2>
    {% if top_events %}
      <table>
        <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞</th>
            <th>–û—Ä–≥–∞–Ω—ñ–∑–∞—Ç–æ—Ä</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>RSVP</th>
            <th>–î–∞—Ç–∞</th>
            <th>–î—ñ—ó</th>
          </tr>
        </thead>
        <tbody>
          {% for event in top_events %}
            <tr>
              <td><a href="/events/{{ event.id }}/">{{ event.title }}</a></td>
              <td>{{ event.organizer.username }}</td>
              <td><span class="badge {{ event.status }}">{{ event.get_status_display }}</span></td>
              <td><strong>{{ event.rsvp_count }}</strong></td>
              <td>{{ event.starts_at|date:"d.m.Y" }}</td>
              <td><a href="/events/{{ event.id }}/edit/">‚úèÔ∏è</a></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>–ù–µ–º–∞—î –ø–æ–¥—ñ–π</p>
    {% endif %}
  </div>
  {% endif %}

  {% if tab == 'events' %}
  <!-- –í–∫–ª–∞–¥–∫–∞: –ü–æ–¥—ñ—ó -->
  <div class="admin-section">
    <h2>üé´ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–æ–¥—ñ—è–º–∏</h2>
    <div style="margin-bottom: 16px;">
      <a role="button" href="/events/create/">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ–¥—ñ—é</a>
    </div>
    
    <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
    <div class="filters-card card">
      <form method="get">
        <input type="hidden" name="tab" value="events" />
        
        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 12px; align-items: end;">
          <div>
            <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–ü–æ—à—É–∫</label>
            <input type="search" name="q" value="{{ q }}" placeholder="–ü–æ—à—É–∫..." />
          </div>
          
          <div>
            <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–°—Ç–∞—Ç—É—Å</label>
            <select name="status">
              <option value="">–í—Å—ñ</option>
              <option value="draft" {% if status == 'draft' %}selected{% endif %}>–ß–µ—Ä–Ω–µ—Ç–∫–∞</option>
              <option value="published" {% if status == 'published' %}selected{% endif %}>–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ</option>
              <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>–°–∫–∞—Å–æ–≤–∞–Ω–æ</option>
              <option value="archived" {% if status == 'archived' %}selected{% endif %}>–ê—Ä—Ö—ñ–≤</option>
            </select>
          </div>
          
          <div>
            <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
            <input type="search" name="category" value="{{ category }}" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ—è, –≤–µ–±—ñ–Ω–∞—Ä" />
          </div>
          
          <div>
            <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">üë§ –û—Ä–≥–∞–Ω—ñ–∑–∞—Ç–æ—Ä</label>
            <select name="organizer">
              <option value="">–í—Å—ñ</option>
              {% for user in all_users %}
                <option value="{{ user.id }}" {% if organizer == user.id|stringformat:"s" %}selected{% endif %}>{{ user.username }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div>
            <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–î–∞—Ç–∞</label>
            <select name="date_filter">
              <option value="">–í—Å—ñ</option>
              <option value="upcoming" {% if date_filter == 'upcoming' %}selected{% endif %}>–ú–∞–π–±—É—Ç–Ω—ñ</option>
              <option value="today" {% if date_filter == 'today' %}selected{% endif %}>–°—å–æ–≥–æ–¥–Ω—ñ</option>
              <option value="past" {% if date_filter == 'past' %}selected{% endif %}>–ú–∏–Ω—É–ª—ñ</option>
              <option value="this_week" {% if date_filter == 'this_week' %}selected{% endif %}>–¶–µ–π —Ç–∏–∂–¥–µ–Ω—å</option>
              <option value="this_month" {% if date_filter == 'this_month' %}selected{% endif %}>–¶–µ–π –º—ñ—Å—è—Ü—å</option>
            </select>
          </div>
          
          <div>
            <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–ü–æ–ø—É–ª—è—Ä–Ω—ñ—Å—Ç—å</label>
            <select name="popularity">
              <option value="">–í—Å—ñ</option>
              <option value="popular" {% if popularity == 'popular' %}selected{% endif %}>–ü–æ–ø—É–ª—è—Ä–Ω—ñ (5+)</option>
              <option value="medium" {% if popularity == 'medium' %}selected{% endif %}>–°–µ—Ä–µ–¥–Ω—ñ (1-4)</option>
              <option value="none" {% if popularity == 'none' %}selected{% endif %}>–ë–µ–∑ RSVP</option>
            </select>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px;">
          <div>
            <label style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; display: block; min-height: 20px;">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è</label>
            <select name="sort">
              <option value="date_desc" {% if sort == 'date_desc' or not sort %}selected{% endif %}>–ù–∞–π–Ω–æ–≤—ñ—à—ñ</option>
              <option value="date_asc" {% if sort == 'date_asc' %}selected{% endif %}>–ù–∞–π—Å—Ç–∞—Ä—ñ—à—ñ</option>
              <option value="popular" {% if sort == 'popular' %}selected{% endif %}>–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—ñ</option>
              <option value="alphabet" {% if sort == 'alphabet' %}selected{% endif %}>–ó–∞ –∞–ª—Ñ–∞–≤—ñ—Ç–æ–º</option>
              <option value="event_date" {% if sort == 'event_date' %}selected{% endif %}>–ü–æ –¥–∞—Ç—ñ –ø–æ–¥—ñ—ó</option>
            </select>
          </div>
          
          <div style="display: flex; gap: 8px; padding-top: 26px;">
            <button type="submit">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
            {% if q or status or organizer or category or date_filter or popularity or sort %}
              <a role="button" class="secondary" href="/?tab=events">–°–∫–∏–Ω—É—Ç–∏</a>
            {% endif %}
          </div>
        </div>
      </form>
    </div>
    
    {% if q or status or organizer or category or date_filter or popularity or sort %}
      <p style="margin: 12px 0; color: var(--muted);">
        –ó–Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—ñ–π: <strong>{{ events_count }}</strong>
        {% if sort %}
          <span style="margin-left: 12px;">
            –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è: 
            {% if sort == 'date_desc' %}–ù–∞–π–Ω–æ–≤—ñ—à—ñ{% endif %}
            {% if sort == 'date_asc' %}–ù–∞–π—Å—Ç–∞—Ä—ñ—à—ñ{% endif %}
            {% if sort == 'popular' %}–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—ñ{% endif %}
            {% if sort == 'alphabet' %}–ó–∞ –∞–ª—Ñ–∞–≤—ñ—Ç–æ–º{% endif %}
            {% if sort == 'event_date' %}–ü–æ –¥–∞—Ç—ñ –ø–æ–¥—ñ—ó{% endif %}
          </span>
        {% endif %}
      </p>
    {% endif %}
    
    {% if recent_events %}
      <table>
        <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞</th>
            <th>–û—Ä–≥–∞–Ω—ñ–∑–∞—Ç–æ—Ä</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>RSVP</th>
            <th>–î–∞—Ç–∞</th>
            <th>–î—ñ—ó</th>
          </tr>
        </thead>
        <tbody>
          {% for event in recent_events %}
            <tr>
              <td><a href="/events/{{ event.id }}/">{{ event.title }}</a></td>
              <td>{{ event.organizer.username }}</td>
              <td><span class="badge {{ event.status }}">{{ event.get_status_display }}</span></td>
              <td><strong>{{ event.rsvp_count|default:0 }}</strong></td>
              <td>{{ event.starts_at|date:"d.m.Y H:i" }}</td>
              <td>
                <a href="/events/{{ event.id }}/participants/">üë•</a>
                <a href="/events/{{ event.id }}/edit/">‚úèÔ∏è</a>
                {% if event.status != 'cancelled' %}
                  <a href="/events/{{ event.id }}/cancel/" onclick="return confirm('–°–∫–∞—Å—É–≤–∞—Ç–∏?')">üö´</a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="flash info" style="margin: 20px 0;">
        –ü–æ–¥—ñ–π –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–±–æ <a href="/?tab=events">—Å–∫–∏–Ω—É—Ç–∏</a> —ó—Ö.
      </div>
    {% endif %}
  </div>
  {% endif %}

  {% if tab == 'users' %}
  <!-- –í–∫–ª–∞–¥–∫–∞: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ -->
  <div class="admin-section">
    <h2>üë• –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</h2>
    <div style="margin-bottom: 16px;">
      <a role="button" href="/accounts/admin/create-user/">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</a>
    </div>
    <table>
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>–ü–æ–¥—ñ—ó —Å—Ç–≤–æ—Ä–µ–Ω–æ</th>
          <th>RSVP –∑—Ä–æ–±–ª–µ–Ω–æ</th>
          <th>–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó</th>
          <th>Staff</th>
        </tr>
      </thead>
      <tbody>
        {% for user in recent_users %}
          <tr>
            <td><strong>{{ user.username }}</strong></td>
            <td>{{ user.email|default:"‚Äî" }}</td>
            <td>{{ user.organized_events.count }}</td>
            <td>{{ user.rsvp_set.count }}</td>
            <td>{{ user.date_joined|date:"d.m.Y H:i" }}</td>
            <td>{% if user.is_staff %}‚úÖ{% else %}‚Äî{% endif %}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  {% if tab == 'rsvps' %}
  <!-- –í–∫–ª–∞–¥–∫–∞: RSVP -->
  <div class="admin-section">
    <h2>üìù –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è–º–∏</h2>
    <table>
      <thead>
        <tr>
          <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
          <th>–ü–æ–¥—ñ—è</th>
          <th>–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó</th>
          <th>–î—ñ—ó</th>
        </tr>
      </thead>
      <tbody>
        {% for rsvp in recent_rsvps %}
          <tr>
            <td><strong>{{ rsvp.user.username }}</strong></td>
            <td><a href="/events/{{ rsvp.event.id }}/">{{ rsvp.event.title }}</a></td>
            <td>{{ rsvp.created_at|date:"d.m.Y H:i" }}</td>
            <td><a href="/events/{{ rsvp.event.id }}/participants/">–£—á–∞—Å–Ω–∏–∫–∏</a></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
{% endblock %}
